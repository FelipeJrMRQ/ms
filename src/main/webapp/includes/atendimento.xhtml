<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:p="http://primefaces.org/ui" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:pm="http://primefaces.org/mobile">


<h:form id="frmAtendimento">


	<p:poll interval="20" update=":tbView:frmAtendimento:tbAtendimento" listener="#{atendimentoBean.consultaAtendimentosIni}" /> 


	<h3 class="text-success">Em atendimento</h3>
	<p:dataTable id="tbAtendimento" value="#{atendimentoBean.atendimentos}" var="atdm" paginator="true" rows="15" emptyMessage="Não há atendimentos iniciados!">
		<p:column width="20">
			<p:rowToggler />
		</p:column>

		<p:column headerText="EMPRESA">
			<h:outputLabel value="#{atdm.registro.empresa.nome}" styleClass="text-success" />
		</p:column>

		<p:column headerText="TEMPO" width="70" styleClass="align">
			<p:outputLabel value="#{atendimentoBean.calculaDuracao(atdm.data_inicio, atdm.data_fim)}" />
		</p:column>
		<p:column headerText="FINALIZAR" width="80" styleClass="align">
			<p:commandButton icon="ui-icon-check" id="btnOpcao" actionListener="#{atendimentoBean.selecionado}" oncomplete="PF('dlgNotasLiberacao').show()" update=":tbView:notasLiberacao" rendered="#{atdm.status == 'INICIADO'}">
				<f:attribute name="registroSelecionado" value="#{atdm}" />
				<p:tooltip for="btnOpcao" value="Finalizar Atendimento" />
			</p:commandButton>
			<p:commandButton icon="fa fa-mail-reply" id="btnDesfazer" actionListener="#{atendimentoBean.desfazerAtendimento}" update=":mensagem :tbView:frmAtendimento:tbAtendimento :tbView:tbRegistrosPrestadores :tbView:notasLiberacao" rendered="#{atdm.status == 'INICIADO'}">
				<f:attribute name="atendimentoSelecionado" value="#{atdm}" />
				<p:tooltip value="Desfazer atendimento!" for="btnDesfazer"></p:tooltip>
				<p:confirm message="Deseja realmente desfazer este atendimento?" header="Alteração atendimento" icon="ui-icon-alert" />
			</p:commandButton>
		</p:column>
		<p:rowExpansion>
			<h:panelGrid columns="1" style="width:600px;">
				<p:column>
					<h:outputLabel value="PRESTADOR: " styleClass="negrito" />
					<h:outputLabel value="#{atdm.registro.prestadorDeServico.nome}" />
				</p:column>
				<p:column>
					<h:outputLabel value="CPF: " styleClass="negrito" />
					<h:outputLabel value="#{atdm.registro.prestadorDeServico.cpf}" />
				</p:column>
				<p:column>
					<h:outputLabel value="VEÍCULO: " styleClass="negrito" />
					<h:outputLabel value="#{atdm.registro.placaVeiculo}" />
				</p:column>
				<p:column>
					<p:dataList value="#{atdm.registro.notas}" var="nfe">
						<f:facet name="header">
							<p:outputLabel value="Notas fiscais vinculadas" />
						</f:facet>
						<p:outputLabel value="#{nfe.numeroNfe}" />
					</p:dataList>
				</p:column>
				<p:column>
					<h:outputLabel value="Iniciado:" />
					<h:outputLabel value="#{atdm.usuario_inicio.nome}" />
				</p:column>
				<p:column>
					<h:outputLabel value="Finalizado por:" />
					<h:outputLabel value="#{atdm.usuario_fim.nome}" />
				</p:column>
			</h:panelGrid>
		</p:rowExpansion>
	</p:dataTable>



</h:form>

<p:dialog widgetVar="dlgNotasLiberacao" id="notasLiberacao" header="Liberação" modal="true" appendTo="@(body)" width="450" resizable="false" hideEffect="fade" showEffect="fade" closable="false">
	<h:panelGrid columns="2">
		<h:form id="frmNotaLiberacao">
			<p:inputText value="#{atendimentoBean.numeroNf}" size="25" id="iptNfeLiberacao" maxlength="44" />
			<p:focus for="iptNfeLiberacao" />
			<p:commandButton icon="ui-icon-plus" actionListener="#{atendimentoBean.addNotas}" update=":tbView:tbNotasLiberacao :tbView:frmNotaLiberacao" id="btnInserir">
				<p:tooltip for="btnInserir" value="Inserir nota fiscal" />
			</p:commandButton>
		</h:form>
	</h:panelGrid>
	<p:dataTable value="#{atendimentoBean.notas}" var="notas" id="tbNotasLiberacao" paginator="true" rows="3">
		<p:column headerText="Número NF">
			<h:outputText value="#{notas.numeroNfe}" />
		</p:column>
		<p:column headerText="Excluir" styleClass="align">
			<p:commandButton icon="ui-icon-trash" actionListener="#{atendimentoBean.removeNota}" update=":mensagem :tbView:tbNotasLiberacao">
				<f:attribute name="notaSelecionada" value="#{notas}" />
			</p:commandButton>
		</p:column>
	</p:dataTable>
	<br />
	<p:commandButton value="Finalizar" process="@this" actionListener="#{atendimentoBean.validaFimAtendimento}" update=":mensagem :tbView:frmAtendimento:tbAtendimento" onclick="PF('dlgNotasLiberacao').hide()" />
	<p:commandButton value="Fechar" actionListener="#{atendimentoBean.limparListaNotas}" update=":tbView:frmNotaLiberacao :tbView:tbNotasLiberacao" onclick="PF('dlgNotasLiberacao').hide()" style="margin-left:10px"/>
</p:dialog>

<!-- DIALOGO DE CONFIRMAÇÃO -->
<p:confirmDialog global="true" showEffect="fade" hideEffect="fade" styleClass="center">
	<p:commandButton value="SIM" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
	<p:commandButton value="NÂO" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
</p:confirmDialog>

</html>